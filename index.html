<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLIZKO</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#666;
      --card:#ffffff;
      --border:#eeeeee;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --accent:#ff9a6a;
      --accent2:#ffb08a;
      --pill:#f6f6f6;
      --radius:18px;
      --bubbleMe:#fff1ea;
      --bubbleOther:#f6f6f6;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 120px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), #ff6f91);
      box-shadow: 0 6px 16px rgba(255,154,106,.45);
    }
    .me{
      font-size: 13px;
      color: var(--muted);
      text-align:right;
      line-height: 1.2;
      user-select:none;
    }
    .title{
      font-size: 22px;
      font-weight: 800;
      margin: 6px 0 10px;
    }
    .subtitle{
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 10px;
    }
    .chat{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 12px;
      align-items: center;
    }
    .avatar{
      width: 54px; height: 54px;
      border-radius: 16px;
      background: linear-gradient(135deg, #ffe1d5, #ffd0ba);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      color:#7a3a22;
      flex: 0 0 auto;
      overflow:hidden;
    }
    .content{
      flex: 1 1 auto;
      min-width: 0;
    }
    .row1{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .name{
      font-weight: 800;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }
    .pill{
      background: var(--pill);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #333;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .row2{
      margin-top: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .preview{
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }
    .btn{
      border: none;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 10px 22px rgba(255,154,106,.35);
      flex: 0 0 auto;
    }
    .btn:active{ transform: translateY(1px); }
    .empty{
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 16px;
      color: var(--muted);
      background: #fafafa;
    }
    .chatHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .back{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .chatTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .chatTitle .who{
      font-weight: 900;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chatTitle .timer{
      color: var(--muted);
      font-size: 12px;
    }
    .messages{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-bottom: 8px;
    }
    .msgRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .msgRow.me{ justify-content:flex-end; }
    .bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.25;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
      word-break: break-word;
      white-space: pre-wrap;
    }
    .bubble.me{
      background: var(--bubbleMe);
      border-top-right-radius: 8px;
    }
    .bubble.other{
      background: var(--bubbleOther);
      border-top-left-radius: 8px;
    }
    .time{
      font-size: 11px;
      color: var(--muted);
      user-select:none;
      flex: 0 0 auto;
    }
    .inputBar{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      padding: 10px 12px;
    }
    .inputInner{
      max-width: 520px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .field{
      flex: 1 1 auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      font-size: 14px;
      outline: none;
    }
    .send{
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 10px 22px rgba(255,154,106,.35);
      flex: 0 0 auto;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .hidden{ display:none; }
  </style>
</head>

<body>
  <!-- LIST SCREEN -->
  <div id="screenList">
    <div class="wrap">
      <div class="topbar">
        <div class="brand"><span class="dot"></span> BLIZKO</div>
        <div class="me" id="me">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>

      <div class="title">üí¨ –ú–æ–∏ —á–∞—Ç—ã</div>
      <div class="subtitle">–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏. –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è ‚Äî —á–∞—Ç –∏—Å—á–µ–∑–Ω–µ—Ç.</div>

      <div id="list" class="list"></div>
      <div class="note" id="hint"></div>
    </div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="screenChat" class="hidden">
    <div class="wrap">
      <div class="chatHeader">
        <button class="back" id="btnBack">‚Üê –ß–∞—Ç—ã</button>

        <div class="chatTitle">
          <div class="who" id="chatWho">–ß–∞—Ç</div>
          <div class="timer" id="chatTimer">‚è≥ ...</div>
        </div>

        <div class="pill" id="chatPill">24—á</div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="note" id="chatNote">
        –†–µ–∞–ª—å–Ω—ã–π —á–∞—Ç –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞. –°–æ–æ–±—â–µ–Ω–∏—è —É—Ö–æ–¥—è—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
      </div>
    </div>

    <div class="inputBar">
      <div class="inputInner">
        <input id="input" class="field" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="500" />
        <button id="btnSend" class="send">–û—Ç–ø—Ä</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // –í–ê–ñ–ù–û: –æ–¥–∏–Ω –¥–æ–º–µ–Ω = –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å. API_BASE –±–µ—Ä—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    const API_BASE = location.origin;

    const user = tg.initDataUnsafe?.user;
    document.getElementById("me").textContent =
      user ? `–¢—ã: ${user.first_name} (id: ${user.id})` : "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram";

    let chats = [];
    let activeChatId = null;

    function pad2(n){ return String(n).padStart(2, "0"); }

    function formatRemaining(ms){
      if(ms <= 0) return "–∏—Å—Ç—ë–∫";
      const totalMin = Math.ceil(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      if(h <= 0) return `${m}–º`;
      return `${h}—á ${pad2(m)}–º`;
    }

    function formatTime(ts){
      const d = new Date(ts);
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function showList(){
      document.getElementById("screenChat").classList.add("hidden");
      document.getElementById("screenList").classList.remove("hidden");
      activeChatId = null;
      renderList();
    }

    function showChat(chatId){
      activeChatId = chatId;
      document.getElementById("screenList").classList.add("hidden");
      document.getElementById("screenChat").classList.remove("hidden");
      renderChat();
      scrollChatToBottom();
    }

    function getActiveChat(){
      return chats.find(c => c.chatId === activeChatId) || null;
    }

    async function apiGet(path){
      const res = await fetch(`${API_BASE}${path}`, { method: "GET" });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}
      if(!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
      return data;
    }

    async function apiPost(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}
      if(!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
      return data;
    }

    async function loadChats(){
      if(!user?.id) return;
      const data = await apiGet(`/api/chats?userId=${encodeURIComponent(user.id)}`);
      chats = Array.isArray(data?.chats) ? data.chats : [];
    }

    async function loadMessages(chatId){
      if(!user?.id) return [];
      const data = await apiGet(`/api/messages?userId=${encodeURIComponent(user.id)}&chatId=${encodeURIComponent(chatId)}`);
      return Array.isArray(data?.messages) ? data.messages : [];
    }

    async function renderList(){
      try{
        await loadChats();
      } catch (e){
        const list = document.getElementById("list");
        list.innerHTML = "";
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.innerHTML = `<b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</b><br/>${String(e).replaceAll("<","&lt;")}`;
        list.appendChild(empty);
        document.getElementById("hint").textContent = "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ /api/chats –æ—Ç–≤–µ—á–∞–µ—Ç.";
        return;
      }

      const t = Date.now();
      chats = chats.filter(c => (c.expiresAt ?? 0) > t);

      const list = document.getElementById("list");
      list.innerHTML = "";

      if(chats.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.innerHTML = `<b>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤.</b><br/>–ß–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.`;
        list.appendChild(empty);
        document.getElementById("hint").textContent =
          "–ü–æ–∫–∞ —á–∞—Ç-–ª–∏—Å—Ç –ø—É—Å—Ç–æ–π. –î–∞–ª—å—à–µ –º—ã —Å–≤—è–∂–µ–º —ç—Ç–æ —Å –º—ç—Ç—á–∞–º–∏ –∏–∑ –±–æ—Ç–∞.";
        return;
      }

      document.getElementById("hint").textContent =
        "–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫—É.";

      chats
        .sort((a,b) => a.expiresAt - b.expiresAt)
        .forEach(c => {
          const msLeft = c.expiresAt - Date.now();

          const el = document.createElement("div");
          el.className = "chat";
          el.innerHTML = `
            <div class="avatar" aria-hidden="true">${c.avatarText || "‚Ä¢"}</div>
            <div class="content">
              <div class="row1">
                <div class="name">${escapeHtml(c.name || "–ë–µ–∑ –∏–º–µ–Ω–∏")}</div>
                <div class="pill">‚è≥ ${formatRemaining(msLeft)}</div>
              </div>
              <div class="row2">
                <div class="preview">${escapeHtml(c.last || "")}</div>
                <button class="btn" data-open="${escapeAttr(c.chatId)}">–û—Ç–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });

      [...document.querySelectorAll('button[data-open]')].forEach(btn => {
        btn.onclick = () => showChat(btn.getAttribute("data-open"));
      });
    }

    async function renderChat(){
      const chat = getActiveChat();
      if(!chat){
        showList();
        return;
      }

      const msLeft = chat.expiresAt - Date.now();
      if(msLeft <= 0){
        tg.showAlert("–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.");
        showList();
        return;
      }

      document.getElementById("chatWho").textContent = chat.name || "–ß–∞—Ç";
      document.getElementById("chatTimer").textContent = `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${formatRemaining(msLeft)}`;
      document.getElementById("chatPill").textContent = formatRemaining(msLeft);

      const box = document.getElementById("messages");
      box.innerHTML = "";

      let messages = [];
      try{
        messages = await loadMessages(chat.chatId);
      } catch(e){
        const row = document.createElement("div");
        row.className = "empty";
        row.innerHTML = `<b>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.</b><br/>${escapeHtml(String(e))}`;
        box.appendChild(row);
        return;
      }

      messages.forEach(m => {
        const row = document.createElement("div");
        row.className = "msgRow " + (m.from === "me" ? "me" : "other");

        const bubble = document.createElement("div");
        bubble.className = "bubble " + (m.from === "me" ? "me" : "other");
        bubble.textContent = m.text;

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = formatTime(m.ts);

        if(m.from === "me"){
          row.appendChild(time);
          row.appendChild(bubble);
        } else {
          row.appendChild(bubble);
          row.appendChild(time);
        }
        box.appendChild(row);
      });
    }

    function scrollChatToBottom(){
      const box = document.getElementById("messages");
      setTimeout(() => {
        box.scrollTop = box.scrollHeight;
        window.scrollTo(0, document.body.scrollHeight);
      }, 0);
    }

    async function sendMessage(){
      const chat = getActiveChat();
      if(!chat) return;

      const msLeft = chat.expiresAt - Date.now();
      if(msLeft <= 0){
        tg.showAlert("–ß–∞—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –°–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.");
        showList();
        return;
      }

      const input = document.getElementById("input");
      const text = (input.value || "").trim();
      if(text.length === 0) return;

      input.value = "";

      try{
        await apiPost("/api/send", {
          userId: user.id,
          chatId: chat.chatId,
          text
        });
      } catch(e){
        tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + String(e));
        return;
      }

      await renderChat();
      scrollChatToBottom();
    }

    document.getElementById("btnBack").onclick = showList;
    document.getElementById("btnSend").onclick = sendMessage;

    document.getElementById("input").addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        sendMessage();
      }
    });

    setInterval(() => {
      if(activeChatId){
        renderChat();
      } else {
        renderList();
      }
    }, 20000);

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(str) {
      return escapeHtml(str).replaceAll("`", "&#096;");
    }

    renderList();
  </script>
</body>
</html>
