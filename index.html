<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLIZKO</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#666;
      --card:#ffffff;
      --border:#eeeeee;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --accent:#ff9a6a;
      --accent2:#ffb08a;
      --pill:#f6f6f6;
      --radius:18px;
      --bubbleMe:#fff1ea;
      --bubbleOther:#f6f6f6;
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 120px;
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), #ff6f91);
      box-shadow: 0 6px 16px rgba(255,154,106,.45);
    }

    .me{
      font-size: 13px;
      color: var(--muted);
      text-align:right;
      line-height: 1.2;
      user-select:none;
    }

    /* LIST */
    .title{
      font-size: 22px;
      font-weight: 800;
      margin: 6px 0 10px;
    }

    .subtitle{
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 10px;
    }

    .chat{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 12px;
      align-items: center;
    }

    .avatar{
      width: 54px; height: 54px;
      border-radius: 16px;
      background: linear-gradient(135deg, #ffe1d5, #ffd0ba);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      color:#7a3a22;
      flex: 0 0 auto;
      overflow:hidden;
    }

    .content{
      flex: 1 1 auto;
      min-width: 0;
    }

    .row1{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .name{
      font-weight: 800;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }

    .pill{
      background: var(--pill);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #333;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .row2{
      margin-top: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .preview{
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }

    .btn{
      border: none;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 10px 22px rgba(255,154,106,.35);
      flex: 0 0 auto;
    }
    .btn:active{ transform: translateY(1px); }

    .empty{
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 16px;
      color: var(--muted);
      background: #fafafa;
    }

    /* CHAT SCREEN */
    .chatHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .back{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      flex: 0 0 auto;
    }

    .chatTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .chatTitle .who{
      font-weight: 900;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .chatTitle .timer{
      color: var(--muted);
      font-size: 12px;
    }

    .messages{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-bottom: 8px;
    }

    .msgRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }

    .msgRow.me{
      justify-content:flex-end;
    }

    .bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.25;
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .bubble.me{
      background: var(--bubbleMe);
      border-top-right-radius: 8px;
    }

    .bubble.other{
      background: var(--bubbleOther);
      border-top-left-radius: 8px;
    }

    .time{
      font-size: 11px;
      color: var(--muted);
      user-select:none;
      flex: 0 0 auto;
    }

    /* INPUT BAR */
    .inputBar{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      padding: 10px 12px;
    }

    .inputInner{
      max-width: 520px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .field{
      flex: 1 1 auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      font-size: 14px;
      outline: none;
    }

    .send{
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 10px 22px rgba(255,154,106,.35);
      flex: 0 0 auto;
    }

    .note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }

    .hidden{ display:none; }
  </style>
</head>

<body>
  <!-- LIST SCREEN -->
  <div id="screenList">
    <div class="wrap">
      <div class="topbar">
        <div class="brand"><span class="dot"></span> BLIZKO</div>
        <div class="me" id="me">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>

      <div class="title">üí¨ –ú–æ–∏ —á–∞—Ç—ã</div>
      <div class="subtitle">–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏. –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è ‚Äî —á–∞—Ç –∏—Å—á–µ–∑–Ω–µ—Ç.</div>

      <div id="list" class="list"></div>
      <div class="note" id="hint"></div>
    </div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="screenChat" class="hidden">
    <div class="wrap">
      <div class="chatHeader">
        <button class="back" id="btnBack">‚Üê –ß–∞—Ç—ã</button>

        <div class="chatTitle">
          <div class="who" id="chatWho">–ß–∞—Ç</div>
          <div class="timer" id="chatTimer">‚è≥ ...</div>
        </div>

        <div class="pill" id="chatPill">24—á</div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="note" id="chatNote">
        –°–µ–π—á–∞—Å —ç—Ç–æ UI-—Ä–µ–∂–∏–º. –î–∞–ª—å—à–µ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä –∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
      </div>
    </div>

    <div class="inputBar">
      <div class="inputInner">
        <input id="input" class="field" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="500" />
        <button id="btnSend" class="send">–û—Ç–ø—Ä</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // ===== USER =====
    const user = tg.initDataUnsafe?.user;
    document.getElementById("me").textContent =
      user ? `–¢—ã: ${user.first_name} (id: ${user.id})` : "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram";

    // ===== DEMO DATA =====
    const now = Date.now();
    let chats = [
      {
        chatId: "c1",
        name: "–ê–ª–∏—Å–∞",
        last: "–û–∫–µ–π, —Ç–æ–≥–¥–∞ —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ —Å–ø–µ—à–∫–∏ üôÇ",
        expiresAt: now + 1000 * 60 * 60 * 21 + 1000 * 60 * 13,
        avatarText: "–ê",
        messages: [
          { from: "other", text: "–ü—Ä–∏–≤–µ—Ç. –£ —Ç–µ–±—è —Ç–æ–∂–µ –≤—Å—ë –±—ã—Å—Ç—Ä–æ –∏ –ø–æ –¥–µ–ª—É?", ts: now - 1000*60*18 },
          { from: "me", text: "–î–∞. –î–∞–≤–∞–π –±–µ–∑ –¥–æ–ª–≥–∏—Ö –∞–Ω–∫–µ—Ç. –¢—ã –≥–¥–µ –ø—Ä–∏–º–µ—Ä–Ω–æ?", ts: now - 1000*60*17 },
          { from: "other", text: "–¶–µ–Ω—Ç—Ä. –ú–æ–∂–µ–º –∑–∞–≤—Ç—Ä–∞ –∫–æ—Ñ–µ –Ω–∞ —á–∞—Å.", ts: now - 1000*60*16 },
          { from: "me", text: "–û–∫–µ–π. –°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ —É–¥–æ–±–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏?", ts: now - 1000*60*15 },
        ]
      },
      {
        chatId: "c2",
        name: "–ö–∞—Ç—è",
        last: "–¢—ã –≤ –∫–∞–∫–æ–º —Ä–∞–π–æ–Ω–µ? –Ø —Ä—è–¥–æ–º.",
        expiresAt: now + 1000 * 60 * 60 * 2 + 1000 * 60 * 5,
        avatarText: "–ö",
        messages: [
          { from: "other", text: "–¢—ã –≤ –∫–∞–∫–æ–º —Ä–∞–π–æ–Ω–µ?", ts: now - 1000*60*8 },
          { from: "me", text: "–ü–æ–∫–∞ –¥–æ–º–∞. –ú–∏–Ω—É—Ç —á–µ—Ä–µ–∑ 30 –º–æ–≥—É –≤—ã–π—Ç–∏.", ts: now - 1000*60*7 },
          { from: "other", text: "–û, —Å—É–ø–µ—Ä. –î–∞–≤–∞–π –±–ª–∏–∂–µ –∫ –º–µ—Ç—Ä–æ.", ts: now - 1000*60*6 },
        ]
      },
      {
        chatId: "c3",
        name: "–õ–∏–∑–∞",
        last: "–î–∞–≤–∞–π –∫–æ—Ä–æ—Ç–∫–æ: –∫–æ—Ñ–µ –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞?",
        expiresAt: now + 1000 * 60 * 26,
        avatarText: "–õ",
        messages: [
          { from: "other", text: "–î–∞–≤–∞–π –∫–æ—Ä–æ—Ç–∫–æ: –∫–æ—Ñ–µ –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞?", ts: now - 1000*60*3 },
          { from: "me", text: "–ü—Ä–æ–≥—É–ª–∫–∞. 40 –º–∏–Ω—É—Ç, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ.", ts: now - 1000*60*2 },
        ]
      }
    ];

    // ===== STATE =====
    let activeChatId = null;

    function pad2(n){ return String(n).padStart(2, "0"); }

    function formatRemaining(ms){
      if(ms <= 0) return "–∏—Å—Ç—ë–∫";
      const totalMin = Math.ceil(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      if(h <= 0) return `${m}–º`;
      return `${h}—á ${pad2(m)}–º`;
    }

    function formatTime(ts){
      const d = new Date(ts);
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function showList(){
      document.getElementById("screenChat").classList.add("hidden");
      document.getElementById("screenList").classList.remove("hidden");
      activeChatId = null;
      renderList();
    }

    function showChat(chatId){
      activeChatId = chatId;
      document.getElementById("screenList").classList.add("hidden");
      document.getElementById("screenChat").classList.remove("hidden");
      renderChat();
      scrollChatToBottom();
    }

    function getActiveChat(){
      return chats.find(c => c.chatId === activeChatId) || null;
    }

    function renderList(){
      // —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç—ë–∫—à–∏–µ
      const t = Date.now();
      chats = chats.filter(c => c.expiresAt > t);

      const list = document.getElementById("list");
      list.innerHTML = "";

      if(chats.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.innerHTML = `<b>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤.</b><br/>–ß–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.`;
        list.appendChild(empty);

        document.getElementById("hint").textContent =
          "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –±–æ—Ç –Ω—É–∂–µ–Ω –¥–ª—è –∞–Ω–∫–µ—Ç –∏ –º—ç—Ç—á–µ–π, –∞ –æ–±—â–µ–Ω–∏–µ ‚Äî –∑–¥–µ—Å—å.";
        return;
      }

      document.getElementById("hint").textContent =
        "–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫—É.";

      chats
        .sort((a,b) => a.expiresAt - b.expiresAt)
        .forEach(c => {
          const msLeft = c.expiresAt - Date.now();

          const el = document.createElement("div");
          el.className = "chat";
          el.innerHTML = `
            <div class="avatar" aria-hidden="true">${c.avatarText || "‚Ä¢"}</div>
            <div class="content">
              <div class="row1">
                <div class="name">${c.name}</div>
                <div class="pill">‚è≥ ${formatRemaining(msLeft)}</div>
              </div>
              <div class="row2">
                <div class="preview">${c.last || ""}</div>
                <button class="btn" data-open="${c.chatId}">–û—Ç–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          `;

          list.appendChild(el);
        });

      [...document.querySelectorAll('button[data-open]')].forEach(btn => {
        btn.onclick = () => showChat(btn.getAttribute("data-open"));
      });
    }

    function renderChat(){
      const chat = getActiveChat();
      if(!chat){
        showList();
        return;
      }

      // –µ—Å–ª–∏ —á–∞—Ç –∏—Å—Ç—ë–∫ ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –Ω–∞–∑–∞–¥
      const msLeft = chat.expiresAt - Date.now();
      if(msLeft <= 0){
        tg.showAlert("–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.");
        showList();
        return;
      }

      document.getElementById("chatWho").textContent = chat.name;
      document.getElementById("chatTimer").textContent = `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${formatRemaining(msLeft)}`;
      document.getElementById("chatPill").textContent = formatRemaining(msLeft);

      const box = document.getElementById("messages");
      box.innerHTML = "";

      chat.messages.forEach(m => {
        const row = document.createElement("div");
        row.className = "msgRow " + (m.from === "me" ? "me" : "other");

        const bubble = document.createElement("div");
        bubble.className = "bubble " + (m.from === "me" ? "me" : "other");
        bubble.textContent = m.text;

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = formatTime(m.ts);

        if(m.from === "me"){
          row.appendChild(time);
          row.appendChild(bubble);
        } else {
          row.appendChild(bubble);
          row.appendChild(time);
        }

        box.appendChild(row);
      });

      // –æ–±–Ω–æ–≤–∏–º last
      const lastMsg = chat.messages[chat.messages.length - 1];
      if(lastMsg) chat.last = lastMsg.text;
    }

    function scrollChatToBottom(){
      const box = document.getElementById("messages");
      setTimeout(() => {
        window.scrollTo(0, document.body.scrollHeight);
        box.scrollTop = box.scrollHeight;
      }, 0);
    }

    function sendMessage(){
      const chat = getActiveChat();
      if(!chat) return;

      const msLeft = chat.expiresAt - Date.now();
      if(msLeft <= 0){
        tg.showAlert("–ß–∞—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –°–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.");
        showList();
        return;
      }

      const input = document.getElementById("input");
      const text = (input.value || "").trim();
      if(text.length === 0) return;

      chat.messages.push({ from: "me", text, ts: Date.now() });
      input.value = "";

      renderChat();
      scrollChatToBottom();

      // –º–∞–ª–µ–Ω—å–∫–∞—è –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏—è (–¥–µ–º–æ)
      setTimeout(() => {
        const chat2 = getActiveChat();
        if(!chat2) return;
        if(chat2.expiresAt - Date.now() <= 0) return;

        const answers = [
          "–û–∫–µ–π üôÇ",
          "–ü–æ–Ω—è–ª. –î–∞–≤–∞–π —Ç–∞–∫.",
          "–ö–æ—Ä–æ—Ç–∫–æ –∏ —è—Å–Ω–æ.",
          "–ö–æ–≥–¥–∞ —Ç–µ–±–µ —É–¥–æ–±–Ω–æ?",
          "–î–∞–≤–∞–π –±–ª–∏–∂–µ –∫ –≤–µ—á–µ—Ä—É."
        ];
        const reply = answers[Math.floor(Math.random() * answers.length)];
        chat2.messages.push({ from: "other", text: reply, ts: Date.now() });
        renderChat();
        scrollChatToBottom();
      }, 900);
    }

    // ===== EVENTS =====
    document.getElementById("btnBack").onclick = showList;
    document.getElementById("btnSend").onclick = sendMessage;

    document.getElementById("input").addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        sendMessage();
      }
    });

    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      if(activeChatId){
        renderChat();
      } else {
        renderList();
      }
    }, 20000);

    // —Å—Ç–∞—Ä—Ç—É–µ–º —Å–æ —Å–ø–∏—Å–∫–∞
    renderList();
  </script>
</body>
</html>
